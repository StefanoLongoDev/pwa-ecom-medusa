name: Deploy Medusa

on:
  push:
    branches:
      - main
      - preview

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "DEPLOY_ENV=production" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/opt/medusa/production/volk" >> $GITHUB_ENV
            echo "PROJECT_NAME=medusa-production" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=preview" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/opt/medusa/preview/volk" >> $GITHUB_ENV
            echo "PROJECT_NAME=medusa-preview" >> $GITHUB_ENV
          fi

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: DEPLOY_PATH,PROJECT_NAME,DEPLOY_ENV
          command_timeout: 30m
          script: |
            cd $DEPLOY_PATH
            echo "üöÄ Deploying $DEPLOY_ENV..."
            git pull origin ${{ github.ref_name }}
            docker compose -p $PROJECT_NAME build
            docker compose -p $PROJECT_NAME down
            docker compose -p $PROJECT_NAME up -d
            echo "‚è≥ Running database migrations..."
            docker compose -p $PROJECT_NAME exec -T backend npx medusa db:migrate
            echo "‚úÖ Deploy completed!"
